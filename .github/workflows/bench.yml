name: BENCHMARK

# Controls when the action will run.
on:
  pull_request:
    branches: testnet

jobs:
  hardware-benchmarks:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v3

      - name: Set env
        run: |
          echo "HOME=/home/actions" >> $GITHUB_ENV
          pallet=$(grep "impl pallet_" runtime/src/lib.rs | grep "Config for Runtime" | sed 's/impl pallet_//' | cut -f1 -d: | sort)
          for i in $pallet; do
            mkdir -p pallets/$i/src
          done

      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: nightly-2022-03-21
          target: wasm32-unknown-unknown
          profile: minimal
          override: true

      - uses: Swatinem/rust-cache@v1
        continue-on-error: true

      - name: Balances
        shell: bash
        continue-on-error: true
        env:
          PALLET: balances
        run: |
          mkdir -p pallets/$PALLET/src
          ./scripts/bench.sh -p $PALLET -cb

      - name: Difficulty
        shell: bash
        continue-on-error: true
        env:
          PALLET: difficulty
        run: |
          mkdir -p pallets/$PALLET/src
          ./scripts/bench.sh -p $PALLET -cb

      - name: Rewards
        shell: bash
        continue-on-error: true
        env:
          PALLET: rewards
        run: |
          ./scripts/bench.sh -p $PALLET -cb

      - name: Timestamp
        shell: bash
        continue-on-error: true
        env:
          PALLET: timestamp
        run: |
          mkdir -p pallets/$PALLET/src
          ./scripts/bench.sh -p $PALLET -cb

      - name: Creditcoin
        shell: bash
        continue-on-error: true
        env:
          PALLET: creditcoin
        run: |
          OUTPUT=./pallets/$PALLET/src/weights.rs
          ./target/release/creditcoin-node benchmark --chain dev --steps=8 --repeat=8 --pallet pallet_$PALLET --extrinsic='*' --execution wasm --wasm-execution=compiled --heap-pages=10000 --output $OUTPUT
          sed -i s/pallet_$PALLET/super/ $OUTPUT

      - name: Commit changes
        uses: EndBug/add-and-commit@v8
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}
          author_name: hardwareBenchmark
          author_email: creditcoin@gluwa.com
          message: 'Creditcoin benchmarks added'
          github_token: ${{ secrets.GITHUB_TOKEN }}
